name: Build and Release Publications

on:
  push:
    branches:
      - main
    paths:
      - 'sources/**'

permissions:
  contents: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      publications: ${{ steps.filter.outputs.changes }}
    steps:
      - uses: actions/checkout@v3
      
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            duskara_compendium:
              - 'sources/duskara_compendium/**'
            duskara_ttrpg:
              - 'sources/duskara_ttrpg/**'
            duskara_stormtide:
              - 'sources/stormtide/**'
            echoes_in_the_wind:
              - 'sources/echoes_in_the_wind/**'
            whispers_of_dusk:
              - 'sources/whispers_of_dusk/**'
            children_of_the_twilight:
              - 'sources/children_of_the_twilight/**'
            fragments_of_the_twilight_codex:
              - 'sources/fragments_of_the_twilight_codex/**'
            duskaran_names_guidelines:
              - 'sources/worldbuilding/duskaran_names_guidelines.md'
            duskaran_language_handbook:
              - 'sources/worldbuilding/duskaran_language_handbook.md'

  build-and-release:
    needs: detect-changes
    if: needs.detect-changes.outputs.publications != '[]'
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        publication: ${{ fromJSON(needs.detect-changes.outputs.publications) }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Set publication details
        id: pub_details
        run: |
          case "${{ matrix.publication }}" in
            duskara_compendium)
              echo "source_dir=sources/duskara_compendium" >> $GITHUB_OUTPUT
              echo "source_file=duskara_compendium.md" >> $GITHUB_OUTPUT
              ;;
            duskara_ttrpg)
              echo "source_dir=sources/duskara_ttrpg" >> $GITHUB_OUTPUT
              echo "source_file=duskara_ttrpg.md" >> $GITHUB_OUTPUT
              ;;
            duskara_stormtide)
              echo "source_dir=sources/stormtide" >> $GITHUB_OUTPUT
              echo "source_file=duskara_stormtide.md" >> $GITHUB_OUTPUT
              ;;
            echoes_in_the_wind)
              echo "source_dir=sources/echoes_in_the_wind" >> $GITHUB_OUTPUT
              echo "source_file=echoes_in_the_wind.md" >> $GITHUB_OUTPUT
              ;;
            whispers_of_dusk)
              echo "source_dir=sources/whispers_of_dusk" >> $GITHUB_OUTPUT
              echo "source_file=whispers_of_dusk.md" >> $GITHUB_OUTPUT
              ;;
            children_of_the_twilight)
              echo "source_dir=sources/children_of_the_twilight" >> $GITHUB_OUTPUT
              echo "source_file=children_of_the_twilight.md" >> $GITHUB_OUTPUT
              ;;
            fragments_of_the_twilight_codex)
              echo "source_dir=sources/fragments_of_the_twilight_codex" >> $GITHUB_OUTPUT
              echo "source_file=fragments_of_the_twilight_codex.md" >> $GITHUB_OUTPUT
              ;;
            duskaran_names_guidelines)
              echo "source_dir=sources/worldbuilding" >> $GITHUB_OUTPUT
              echo "source_file=duskaran_names_guidelines.md" >> $GITHUB_OUTPUT
              ;;
            duskaran_language_handbook)
              echo "source_dir=sources/worldbuilding" >> $GITHUB_OUTPUT
              echo "source_file=duskaran_language_handbook.md" >> $GITHUB_OUTPUT
              ;;              
          esac
      
      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2
      
      - name: Install TinyTeX
        run: quarto install tinytex
      
      - name: Install fonts
        run: |
          mkdir -p ~/.fonts
          if [ -d fonts ] && [ "$(ls -A fonts/*.ttf 2>/dev/null)" ]; then
            cp fonts/*.ttf ~/.fonts/
            fc-cache -f
          fi
      
      - name: Extract version from frontmatter
        id: get_version
        working-directory: ${{ steps.pub_details.outputs.source_dir }}
        run: |
          VERSION=$(grep '^version:' ${{ steps.pub_details.outputs.source_file }} | sed 's/version: *"\?\([^"]*\)"\?/\1/' | tr -d ' ')
          if [ -z "$VERSION" ]; then
            echo "ERROR: Could not extract version"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Extract metadata from frontmatter
        id: get_metadata
        working-directory: ${{ steps.pub_details.outputs.source_dir }}
        run: |
          # Extract Version
          VERSION=$(grep '^version:' ${{ steps.pub_details.outputs.source_file }} | sed 's/version: *"\?\([^"]*\)"\?/\1/' | tr -d ' ')
          
          # Extract Latest Update
          LATEST_UPDATE=$(grep '^latest_update:' ${{ steps.pub_details.outputs.source_file }} | sed 's/latest_update: *"\?\([^"]*\)"\?/\1/' | tr -d ' ')
          
          if [ -z "$VERSION" ]; then
            echo "ERROR: Could not extract version"
            exit 1
          fi
          
          # If latest_update is not there, use an empty string or the current date (optional)
          if [ -z "$LATEST_UPDATE" ]; then
             LATEST_UPDATE="N/A"
          fi

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "LATEST_UPDATE=$LATEST_UPDATE" >> $GITHUB_OUTPUT

      - name: Render PDF
        working-directory: ${{ steps.pub_details.outputs.source_dir }}
        run: quarto render ${{ steps.pub_details.outputs.source_file }} --to pdf
      
      - name: Render EPUB
        working-directory: ${{ steps.pub_details.outputs.source_dir }}
        run: quarto render ${{ steps.pub_details.outputs.source_file }} --to epub
      
      - name: Render ODT
        working-directory: ${{ steps.pub_details.outputs.source_dir }}
        run: quarto render ${{ steps.pub_details.outputs.source_file }} --to odt
      
      - name: Collect and rename outputs
        run: |
          VERSION="${{ steps.get_metadata.outputs.VERSION }}"
          NAME="${{ matrix.publication }}"
          SOURCE_DIR="${{ steps.pub_details.outputs.source_dir }}"
          SOURCE_FILE="${{ steps.pub_details.outputs.source_file }}"
          
          mkdir -p release_files
          cp "${SOURCE_DIR}/${SOURCE_FILE}" "release_files/${NAME}_v${VERSION}.md"
          mv "${SOURCE_DIR}/${NAME}.pdf" "release_files/${NAME}_v${VERSION}.pdf"
          mv "${SOURCE_DIR}/${NAME}.epub" "release_files/${NAME}_v${VERSION}.epub"
          mv "${SOURCE_DIR}/${NAME}.odt" "release_files/${NAME}_v${VERSION}.odt"
      
      - name: Create individual release
        uses: softprops/action-gh-release@v1
        with:
          files: release_files/*
          tag_name: ${{ matrix.publication }}-v${{ steps.get_metadata.outputs.VERSION }}
          name: "${{ matrix.publication }} v${{ steps.get_metadata.outputs.VERSION }}"
          body: |
            ## ${{ matrix.publication }} v${{ steps.get_metadata.outputs.VERSION }}
            
            **Last Updated:** ${{ steps.get_metadata.outputs.LATEST_UPDATE }}
            
            Automated release of ${{ matrix.publication }}.
            
            Available formats:
            - PDF
            - EPUB
            - ODT
            - Markdown (source)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

#      - name: Upload to itch.io
#        env:
#          BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
#        run: |
#          # Download and setup butler
#          curl -L -o butler.zip https://broth.itch.ovh/butler/linux-amd64/LATEST/archive/default
#          unzip butler.zip
#          chmod +x butler
#          
#          # Push files to itch.io
#          VERSION="${{ steps.get_version.outputs.VERSION }}"
#          NAME="${{ matrix.publication }}"
#          ITCH_USER="your-itch-username"
#          ITCH_GAME="${NAME}"
#          
#          # Upload PDF
#          ./butler push "release_files/${NAME}_v${VERSION}.pdf" "${ITCH_USER}/${ITCH_GAME}:pdf" --userversion "${VERSION}"
#          
#          # Upload EPUB
#          ./butler push "release_files/${NAME}_v${VERSION}.epub" "${ITCH_USER}/${ITCH_GAME}:epub" --userversion "${VERSION}"
#          
#          # Upload ODT
#          ./butler push "release_files/${NAME}_v${VERSION}.odt" "${ITCH_USER}/${ITCH_GAME}:odt" --userversion "${VERSION}"
