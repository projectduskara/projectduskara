name: Build and Release Publications

on:
  push:
    branches:
      - main
    paths:
      - 'sources/**/*.md'
      - 'sources/**/_quarto.yml'

permissions:
  contents: write
  
jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        publication:
          - name: duskara_compendium
            source_dir: sources/duskara_compendium
            source_file: duskara_compendium.md
          - name: duskara_ttrpg
            source_dir: sources/duskara_ttrpg
            source_file: duskara_ttrpg.md
          - name: duskara_stormtide
            source_dir: sources/stormtide
            source_file: duskara_stormtide.md
          - name: echoes_in_the_wind
            source_dir: sources/echoes_in_the_wind
            source_file: echoes_in_the_wind.md
          - name: whispers_of_dusk
            source_dir: sources/whispers_of_dusk
            source_file: whispers_of_dusk.md
          - name: children_of_the_twilight
            source_dir: sources/children_of_the_twilight
            source_file: children_of_the_twilight.md
          - name: fragments_of_the_twilight_codex
            source_dir: sources/fragments_of_the_twilight_codex
            source_file: fragments_of_the_twilight_codex.md
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2
      
      - name: Install TinyTeX
        run: quarto install tinytex
      
      - name: Install fonts
        run: |
          mkdir -p ~/.fonts
          if [ -d fonts ] && [ "$(ls -A fonts/*.ttf 2>/dev/null)" ]; then
            cp fonts/*.ttf ~/.fonts/
            fc-cache -f
          else
            echo "No fonts found, skipping"
          fi
      
      - name: Extract version from frontmatter
        id: get_version
        working-directory: ${{ matrix.publication.source_dir }}
        run: |
          VERSION=$(grep '^version:' ${{ matrix.publication.source_file }} | sed 's/version: *"\?\([^"]*\)"\?/\1/' | tr -d ' ')
          if [ -z "$VERSION" ]; then
            echo "ERROR: Could not extract version"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Render PDF
        working-directory: ${{ matrix.publication.source_dir }}
        run: quarto render ${{ matrix.publication.source_file }} --to pdf
      
      - name: Render EPUB
        working-directory: ${{ matrix.publication.source_dir }}
        run: quarto render ${{ matrix.publication.source_file }} --to epub
      
      - name: Render ODT
        working-directory: ${{ matrix.publication.source_dir }}
        run: quarto render ${{ matrix.publication.source_file }} --to odt
      
      - name: Collect and rename outputs
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          NAME="${{ matrix.publication.name }}"
          SOURCE_DIR="${{ matrix.publication.source_dir }}"
          SOURCE_FILE="${{ matrix.publication.source_file }}"
          
          mkdir -p release_files
          cp "${SOURCE_DIR}/${SOURCE_FILE}" "release_files/${NAME}_v${VERSION}.md"
          mv "${SOURCE_DIR}/${NAME}.pdf" "release_files/${NAME}_v${VERSION}.pdf"
          mv "${SOURCE_DIR}/${NAME}.epub" "release_files/${NAME}_v${VERSION}.epub"
          mv "${SOURCE_DIR}/${NAME}.odt" "release_files/${NAME}_v${VERSION}.odt"
      
      - name: Create individual release
        uses: softprops/action-gh-release@v1
        with:
          files: release_files/*
          tag_name: ${{ matrix.publication.name }}-v${{ steps.get_version.outputs.VERSION }}
          name: "${{ matrix.publication.name }} v${{ steps.get_version.outputs.VERSION }}"
          body: |
            ## ${{ matrix.publication.name }} v${{ steps.get_version.outputs.VERSION }}
            
            Automated release of ${{ matrix.publication.name }}.
            
            Available formats:
            - PDF
            - EPUB
            - ODT
            - Markdown (source)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
